<html>

<head>
	<title>AlephZero Playground</title>
	<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/bulma/0.7.5/css/bulma.min.css" />
	<script src="//cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
	<script defer id="ace" src="//cdnjs.cloudflare.com/ajax/libs/ace/1.4.5/ace.js"></script>

	<script src="//unpkg.com/splitpanes"></script>
	<link href="//unpkg.com/splitpanes/dist/splitpanes.css" rel="stylesheet">
</head>

<body>
	<div id="app">
		<nav class="navbar is-dark">
			<div class="navbar-brand">
				<a class="navbar-item" href="https://github.com/alephzero">
					<img src="https://avatars1.githubusercontent.com/u/48891271" height="28" style="filter: invert(1)">
				</a>
			</div>
			<div class="navbar-menu">
				<div class="navbar-start">
					<div class="navbar-item has-dropdown is-hoverable">
						<a class="navbar-link">
							Language ({{lang_display[selected_lang]}})
						</a>
						<div class="navbar-dropdown">
							<a class="navbar-item" v-for="lang in lang_opts" @click="select_lang(lang)">
								<div
									:class="{'has-text-primary': lang==selected_lang, 'has-text-weight-bold': lang==selected_lang}">
									{{lang_display[lang]}}
								</div>
							</a>
						</div>
					</div>
					<div class="navbar-item has-dropdown is-hoverable">
						<a class="navbar-link">
							Example
						</a>
						<div class="navbar-dropdown">
							<div class="navbar-item"><b>{{lang_display["cc"]}}</b></div>
							<a class="navbar-item" v-for="ex in examples_cc" @click="select_example(ex)">
								{{ex.display}}
							</a>
							<hr class="navbar-divider">
							<div class="navbar-item"><b>{{lang_display["go"]}}</b></div>
							<a class="navbar-item" v-for="ex in examples_go" @click="select_example(ex)">
								{{ex.display}}
							</a>
							<hr class="navbar-divider">
							<div class="navbar-item"><b>{{lang_display["py"]}}</b></div>
							<a class="navbar-item" v-for="ex in examples_py" @click="select_example(ex)">
								{{ex.display}}
							</a>
						</div>
					</div>

					<!-- Load Dropdown -->
					<div class="navbar-item has-dropdown is-hoverable">
						<a class="navbar-link">
							Load Saved Script
						</a>
						<div class="navbar-dropdown">
							
							<template v-if="!(cookies[0] === null)">
								<a class="navbar-item"  v-for="cookie in cookies" @click="select_cookie(cookie)">
									{{cookie.display}}
								</a>
							</template>

						</div>
					</div>


					<!-- Delete Dropdown -->
					<div class="navbar-item has-dropdown is-hoverable">
						<a class="navbar-link">
							Delete Saved Script
						</a>
						<div class="navbar-dropdown">
							
							<template v-if="!(cookies[0] === null)">
								<a class="navbar-item"  v-for="cookie in cookies" @click="delete_cookie(cookie)">
									{{cookie.display}}
								</a>
							</template>

						</div>
					</div>


				</div>


				</div>
				<div class="navbar-end">
					<div class="tag is-dark">Ctrl + ENTER to Run, Ctrl + S to Save</div>
				</div>


		</nav>

		<splitpanes>
			<pane style="margin: 1px">
				<pre id="code" style="height: 100%; font-size: 1.25em;"></pre>
			</pane>
			<pane style="margin: 1px; overflow: auto;">
				<div class="has-background-dark" style="height: 100%;">
					<pre class="has-text-primary has-background-dark" style="font-size: 1em"
						v-if="output_stdout">{{output_stdout}}</pre>
					<pre class="has-text-danger has-background-dark" style="font-size: 1em"
						v-if="output_stderr">{{output_stderr}}</pre>
				</div>
			</pane>
		</splitpanes>
	</div>

	<script>

		function getAllCookies(){
		  let pairs = document.cookie.split(";");
		  let cookies = {};
		  for (let i=0; i<pairs.length; i++){
		    let pair = pairs[i].split("=");
		    cookies[(pair[0]+'').trim()] = unescape(pair.slice(1).join('='));
		  }
		  return cookies;
		}

		function createCookie(name, value, days) {
		    if (days) {
		        let date = new Date();
		        date.setTime(date.getTime() + (days * 24 * 60 * 60 *1000));
		        let expires = "; expires=" + date.toGMTString();
		    } else {
		        let expires = "";
		    }
		    document.cookie = name + "=" + value + expires + "; path=/";
		}

		function readCookie(name) {
		    let nameEQ = name + "=";
		    let ca = document.cookie.split(';');
		    for(let i=0;i < ca.length;i++) {
		        let c = ca[i];
		        while (c.charAt(0)==' ') {
		            c = c.substring(1,c.length);
		        }
		        if (c.indexOf(nameEQ) == 0) {
		            return c.substring(nameEQ.length,c.length);
		        }
		    }
		    return null;
		}

		function eraseCookie(name) {
		    createCookie(name,"",-1);
		}

		const vueobj = new Vue({
			el: '#app',
			components: window.splitpanes,
			data: {
				lang_opts: ['cc', 'go', 'py'],
				lang_display: { cc: 'C++', go: 'Go', py: 'Python' },
				selected_lang: undefined,
				examples: [
					{
						display: 'Publisher',
						lang: 'cc',
						path: '/examples/pub.cc',
					}, {
						display: 'Subscriber',
						lang: 'cc',
						path: '/examples/sub.cc',
					}, {
						display: 'RPC Server',
						lang: 'cc',
						path: '/examples/rpc_server.cc',
					}, {
						display: 'RPC Client',
						lang: 'cc',
						path: '/examples/rpc_client.cc',
					}, {
						display: 'PRPC Server',
						lang: 'cc',
						path: '/examples/prpc_server.cc',
					}, {
						display: 'PRPC Client',
						lang: 'cc',
						path: '/examples/prpc_client.cc',
					}, {
						display: 'Publisher',
						lang: 'go',
						path: '/examples/pub.go',
					}, {
						display: 'Subscriber',
						lang: 'go',
						path: '/examples/sub.go',
					}, {
						display: 'RPC Server',
						lang: 'go',
						path: '/examples/rpc_server.go',
					}, {
						display: 'RPC Client',
						lang: 'go',
						path: '/examples/rpc_client.go',
					}, {
						display: 'PRPC Server',
						lang: 'go',
						path: '/examples/prpc_server.go',
					}, {
						display: 'PRPC Client',
						lang: 'go',
						path: '/examples/prpc_client.go',
					}, {
						display: 'Publisher',
						lang: 'py',
						path: '/examples/pub.py',
					}, {
						display: 'Subscriber',
						lang: 'py',
						path: '/examples/sub.py',
					}, {
						display: 'RPC Server',
						lang: 'py',
						path: '/examples/rpc_server.py',
					}, {
						display: 'RPC Client',
						lang: 'py',
						path: '/examples/rpc_client.py',
					}, {
						display: 'PRPC Server',
						lang: 'py',
						path: '/examples/prpc_server.py',
					}, {
						display: 'PRPC Client',
						lang: 'py',
						path: '/examples/prpc_client.py',
					}, {
						display: 'Subscriber (asyncio)',
						lang: 'py',
						path: '/examples/sub.aio.py',
					}, {
						display: 'RPC Client (asyncio)',
						lang: 'py',
						path: '/examples/rpc_client.aio.py',
					},
				],
				editor: undefined,
				output_stdout: '',
				output_stderr: '',
				ws: undefined,

				// Cookie Variables
				script_name: undefined, // name of the current scripts, might be nice to have down the line
				cookies: []
			},
			mounted() {
				const vm = this
				const ace_script = document.querySelector('#ace')
				ace_script.onload = vm.setup_code_panel

				// Load cookies from browser, save to vuedata
				const all_cookie_names = getAllCookies()
				for (cookie_name in all_cookie_names) {
				  cookie = JSON.parse(readCookie(cookie_name))
				  vm.cookies.push(cookie)
				}
			},

			computed: {
				examples_cc() {
					return this.examples.filter(ex => ex.lang == 'cc')
				},
				examples_go() {
					return this.examples.filter(ex => ex.lang == 'go')
				},
				examples_py() {
					return this.examples.filter(ex => ex.lang == 'py')
				},
			},
			methods: {


				setup_code_panel() {
					const vm = this
					vm.editor = ace.edit('code')
					vm.editor.setTheme('ace/theme/merbivore_soft')
					vm.editor.setKeyboardHandler("ace/keyboard/sublime")
					vm.editor.focus()

					vm.editor.setValue(`print('Hello, World!')\n`, 1)
					vm.select_lang('py')

					vm.editor.commands.addCommand({
						name: 'run_code',
						bindKey: { win: 'Ctrl-Enter', mac: 'Command-Enter' },
						exec: vm.run_code,
					})

					// Control-S -> Save file
					vm.editor.commands.addCommand({
						name: 'save_code',
						bindKey: { win: 'Ctrl-S', mac: 'Command-S' },
						exec: vm.save_code,
					})
				},

				save_code() {
					const vm = this

					// Get script name
					let script_name = prompt("Enter script name:")

					// If user hits the cancel button
					if (script_name == null){
						return
					}

					// User submits blank text
					if (script_name.length == 0){
						alert("Script name can't be empty");
						return
					} 

					// Save Vue script name data with prompt input. might be useful
					vm.script_name = script_name
					document.title = script_name

					cookie = {
						lang: vm.selected_lang, 
						script_name: script_name, 
						display: script_name,
						code: vm.editor.getValue()}
					cookie_str = JSON.stringify(cookie)

					console.log("Saving cookie:", cookie_str)

					// Save cookie to browser
					createCookie(script_name, cookie_str, 2*420)  // save cookie to browser

					// Save cookie to Vue
					vm.cookies.push(cookie)
				},

				select_cookie(cookie) {
					const vm = this
					vm.select_lang(cookie.lang)
					vm.editor.setValue(cookie.code, 1)
					vm.script_name = cookie.script_name
				},

				delete_cookie(cookie) {

					const vm = this
					
					// Remove cookie from browser
					eraseCookie(cookie.script_name)

					// Remove from vue data
					cookie_idx = vm.cookies.indexOf(cookie)
					vm.cookies.splice(cookie_idx, 1);

					alert(`Cookie: '${cookie.script_name}' deleted`)
				},

				run_code() {
					const vm = this

					if (vm.ws) {
						vm.ws.close()
					}
					vm.output_stdout = ''
					vm.output_stderr = ''

					vm.ws = new WebSocket(`ws://${location.host}/api/run`)
					vm.ws.onopen = () => {
						vm.ws.send(JSON.stringify({ lang: vm.selected_lang, code: vm.editor.getValue() }))
					}
					vm.ws.onmessage = (evt) => {
						msg = JSON.parse(evt.data)
						if (msg.stream == 'stdout') {
							vm.output_stdout += msg.output
						}
						if (msg.stream == 'stderr') {
							vm.output_stderr += msg.output
						}
					}
				},

				select_lang(lang) {
					const vm = this
					vm.selected_lang = lang
					if (vm.editor) {
						vm.editor.session.setMode({
							cc: 'ace/mode/c_cpp',
							go: 'ace/mode/golang',
							py: 'ace/mode/python',
						}[lang])
					}
				},

				select_example(example) {
					const vm = this

					if (vm.ws) {
						vm.ws.close()
					}
					vm.output_stdout = ''
					vm.output_stderr = ''

					vm.select_lang(example.lang)
					fetch(example.path)
						.then((r) => { return r.text() })
						.then((code) => { vm.editor.setValue(code, 1) })
				}
			}
		})
	</script>
</body>

</html>
